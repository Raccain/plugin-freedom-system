---
plugin: GrooveScout
stage: 2
phase: DSP.3
status: complete
last_updated: 2026-02-21
complexity_score: 5.0
phased_implementation: true
orchestration_mode: true
next_action: invoke_dsp_agent
next_phase: DSP.4
ui_mockup_version: 5
ui_mockup_status: finalized
contract_checksums:
  creative_brief: sha256:66204469C96D324DA84A1BEB26C8B9112DA9F7AA818970E74B040DE256C5B6CA
  parameter_spec: sha256:3B04E151C0EBBCBDB9E58552EE5EAB25F36899D722CE88A2E2D64D60E7F63B0E
  architecture: sha256:CB6375275C3F037A038129DE5D45B332E1E523946C06664E286A9B7C0288218F
  plan: sha256:E4057F39804478A5C718C7BF68C2AFF300348A117AA0A99624A16FEAA093DF8E
---

# Resume Point

## Current State: Stage 2 DSP.3 Complete — Ready for DSP Phase 4 (Drum Onset + MIDI)

Key detection implemented in GrooveScoutAnalyzer::run() using STFT chromagram (4096-point FFT, Hann window, 50% overlap) + Krumhansl-Schmuckler profile correlation against 24 keys. Includes 100 Hz high-pass pre-filter to reduce kick drum contamination. Root chord MIDI triad derived from detected key. Drum onset detection + MIDI assembly remain stubs pending DSP.4.

## Completed So Far

**Ideation:** Complete
- Core concept defined (audio analyzer — BPM, key, drum MIDI extraction)
- Outputs specified (BPM display + set tempo, key display, draggable MIDI clips per drum)
- Analysis mode: one-shot triggered by Analyze button
- Technical approach: band-separated onset detection, chroma/K-S key detection
- Use cases identified (reference track analysis, sample flipping)

**Stage 0:** Complete - Research & Planning complete - Architecture and plan documented (Complexity 5.0)
- Plugin type: Analysis Utility (effect bus, stereo in/out, audio passes through unchanged)
- Professional examples researched: Mixed In Key, Traktor, Serato, Fadr, iZotope RX
- JUCE modules identified: juce_audio_basics, juce_audio_processors, juce_dsp, juce_core, juce_gui_basics
- DSP feasibility verified: all algorithms implementable with JUCE 8 APIs
- Complexity score: 5.0 (capped) — Complexity Tier 6
- Strategy: Phased implementation (4 DSP phases, 3 GUI phases)
- Plan documented in plan.md

**UI Mockup:** Complete (v5 finalized)
- Dark neon aesthetic: near-black (#0e0e12) + orange accent (#FF9500)
- Input sections (controls/settings): cool blue-dark (#181824)
- Output sections (results/MIDI): warm dark (#17120a)
- 750×560px fixed window
- 7-row layout: title bar / record controls / drum cards / action row / waveform / results / MIDI tiles
- Waveform sits below Analyze button (between action row and BPM/KEY results)
- Animated playhead waveform during both Audition and Analyzing states
- STOP (rec) button always visible — enabled/disabled rather than hidden/shown
- Drum cards: KICK / SNARE / HIHATS with freq range sliders + sensitivity + AUDITION button
- MIDI clip tiles with piano-roll preview, drag-to-DAW handle

**Stage 1:** Complete - Foundation + Shell
- CMakeLists.txt: FORMATS VST3 AU Standalone, NEEDS_WEB_BROWSER TRUE, juce_generate_juce_header()
- PluginProcessor.h/cpp: all 10 APVTS parameters (Float), stereo in/out bus config, zero latency, state save/load
- PluginEditor.h/cpp: 750×560 fixed size stub, dark background (#0e0e12), juce_gui_extra included
- Atomic flags declared: isCapturing, recordingComplete, isPreviewActive, analysisComplete, recordedSamples, analysisProgress, analysisStep, previewPlayhead, previewBand
- Action method stubs: startRecording(), stopCurrentOperation(), startAnalysis(), togglePreview()
- processBlock(): ScopedNoDenormals, audio passthrough (unmodified), no DSP yet

**Stage 2 DSP.1:** Complete - Audio Passthrough + Buffer Capture Infrastructure

**Stage 2 DSP.2:** Complete - BPM Detection via OSS + Generalized Autocorrelation (juce::dsp::FFT)
- 6 missing APVTS parameters added: bpmMultiplier (Choice), analyzeBPM/analyzeKey/analyzeKick/analyzeSnare/analyzeHihat (Bool x5)
- PluginProcessor.h: new members — recordingBuffer, analyzeTriggered, analysisCancelled, analysisError, detectedBpm, detectedKey, kickClipAvailable, snareClipAvailable, hihatClipAvailable, chordClipAvailable, waveformRms, waveformLock, waveformDirty, analyzerThread
- cancelAnalysis() added as public method
- prepareToPlay(): pre-allocates recording buffer (max 30s × sampleRate × 2ch), waveform RMS buffer (200 buckets), resets all analysis state
- processBlock(): recording buffer append (isCapturing path), auto-stop on buffer full, waveformDirty signal, clean passthrough
- All action methods implemented: startRecording(), stopCurrentOperation(), startAnalysis(), cancelAnalysis(), togglePreview() (stub)
- GrooveScoutAnalyzer stub thread created (Source/GrooveScoutAnalyzer.h + .cpp)
- CMakeLists.txt: GrooveScoutAnalyzer.cpp added to target_sources

**Stage 2 DSP.3:** Complete - Key Detection via STFT Chromagram + Krumhansl-Schmuckler
- 100 Hz first-order IIR high-pass pre-filter (kick drum contamination reduction)
- STFT: 4096-point FFT (order 12), 50% overlap (2048-sample hop), Hann window
- Pitch class profile (PCP) accumulation: FFT bins → 12 pitch classes via MIDI pitch mapping
- PCP normalization to unit length; silent/atonal audio returns "Unknown" gracefully
- Krumhansl-Schmuckler correlation: Pearson coefficient against 24 key profiles (12 major + 12 minor)
- Key string output (e.g. "F# minor") stored in proc.detectedKey
- Root chord MIDI derivation: major triad (root, +4, +7) or minor triad (root, +3, +7) in octave 4
- rootChordMidi[3] and rootChordValid added to PluginProcessor.h for DSP.4 consumption
- Thread cancellation checks after mono mix, HP filter, STFT completion, and correlation
- analyzeKey parameter gates the entire key detection block

## Next Steps

1. **Stage 2 DSP Phase 4:** Drum onset detection + MIDI assembly
   - Band-separated IIR onset detection (kick/snare/hihat) using juce::dsp::IIR::Filter
   - Adaptive threshold: mean + (1-sensitivity)*4*stdDev over 40-frame window
   - Onset timing → beat position conversion using detectedBPM
   - MIDI Pattern Assembly: juce::MidiFile (format 0, 480 PPQ), GM drum notes (kick=36, snare=38, hihat=42)
   - Root chord MIDI file from rootChordMidi[3]
   - Write .mid files to temp directory
   - Set kickClipAvailable/snareClipAvailable/hihatClipAvailable/chordClipAvailable flags
2. Stage 3 GUI Phase 1: Layout and basic controls (WebView)
3. Stage 3 GUI Phase 2: Parameter binding and analysis flow
4. Stage 3 GUI Phase 3: MIDI drag-and-drop interaction

## Context to Preserve

**Key Decisions:**
- Plugin type: Analysis Utility (audio passes through unchanged)
- Bus config: stereo in + stereo out (standard effect plugin), FORMATS VST3 AU Standalone
- Core concept: One-click extraction of BPM, key, kick/snare/hihat MIDI from any audio
- MIDI output: Drag-to-track from plugin UI via performExternalDragDropOfFiles()
- Separate MIDI clip per drum type + root chord clip
- Offline analysis: user plays track → presses Analyze → background thread processes accumulated buffer
- Recording buffer: pre-allocated at prepareToPlay(), max 30s
- BPM algorithm: OSS + generalized autocorrelation using juce::dsp::FFT (MiniBPM as fallback)
- Key algorithm: STFT chromagram + Krumhansl-Schmuckler correlation
- Drum separation: per-band IIR bandpass (juce::dsp::IIR::Filter) + adaptive onset detection
- Background thread: juce::Thread subclass with threadShouldExit() cancellation

**Stage 2 DSP.3 files modified:**
- plugins/GrooveScout/Source/GrooveScoutAnalyzer.cpp (key detection replaces stub)
- plugins/GrooveScout/Source/PluginProcessor.h (rootChordMidi[3], rootChordValid added)

**Architecture file:** plugins/GrooveScout/.ideas/architecture.md
**Plan file:** plugins/GrooveScout/.ideas/plan.md
**Parameter spec:** plugins/GrooveScout/.ideas/parameter-spec.md (locked)
**UI mockup:** plugins/GrooveScout/.ideas/mockups/v5-ui.yaml (finalized)
**Complexity:** 5.0 (capped from 9.0)
**Implementation strategy:** 4 DSP phases + 3 GUI phases

**High-risk features:**
1. MIDI drag-and-drop (performExternalDragDropOfFiles — DAW compatibility varies)
2. BPM accuracy on full mixes (half-time/double-time ambiguity, bpmMultiplier correction)
3. Key detection on complex audio (chromagram contamination from drums — mitigated by 100 Hz HP filter)
